#!/bin/bash

UA_TO_IGNORE='useragent:.+?(bot|feed|wget|fetcher|crawler|proxy|bubing|fastladder|ruby|aol\sreader|proximic|hatena|mediapartners-google|subscribe|slurp|phantomjs)'
REQUEST_PATH_TO_IGNORE='(\/yamap-widget-demo-page|\/imageproxy|\/api|favicon\.ico|index\.atom|\.js|\.json|\.css|\.jpe?g|\.png|\.gif|\.txt|\.php|\/admin|\/archives|^\-$|^\/$|\/ogp.+|\/amazon.+\.html|\/imageproxy/)'
APP_DIR='/var/www/app/portalshit'

ACCESS_LOGS=`find ${APP_DIR}/log/access.log* \
  | xargs zcat -f \
  | grep -viP ${UA_TO_IGNORE}`

CACHE_HIT_LOGS=`find ${APP_DIR}/log/access.log* \
  | xargs zcat -f`

# Access Ranking
echo "${ACCESS_LOGS}" \
  | grep 'status:200' \
  | grep -vP '\/(about|morygonzalez|author)' \
  | cut -f5 | sed -e 's/request_uri://' \
  | grep -vP ${REQUEST_PATH_TO_IGNORE} \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee ${APP_DIR}/public/access-ranking.txt

# Referer Ranking
echo "${ACCESS_LOGS}" \
  | grep -vP "request_uri:.+?${REQUEST_PATH_TO_IGNORE}" \
  | sed -e 's/\?amp=1//' \
  | cut -f12 | sed -e 's/referer://' \
  | grep -vP '(^-$|portalshit\.net)' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee ${APP_DIR}/public/referer-ranking.txt

# Cache Hit Rate
echo "${CACHE_HIT_LOGS}" \
  | grep 'cache_hit:' | grep -v 'cache_hit:-' \
  | cut -f16 | sort | uniq -c \
  | awk '{
      if ($2 ~ /HIT/) {
        hit = $1
      };
      if ($2 ~ /EXPIRED/) {
        expire = $1
      };
      if ($2 ~ /MISS/) {
        miss = $1
      };
      sum+=$1
    } END {
      hit_rate = hit / sum * 100;
      expired_rate = expire / sum * 100;
      miss_rate = miss / sum * 100;
      print "HIT\t" hit "\t(" hit_rate "%)"
      print "EXPIRE\t" expire "\t(" expired_rate "%)"
      print "MISS\t" miss "\t(" miss_rate "%)"
    }' \
  | tee ${APP_DIR}/public/cache-hit-rate.txt

# Spam Block Rate
echo "${ACCESS_LOGS}" \
  | grep "POST" | grep -v "uri:/admin/" \
  | grep "referer:https://portalshit.net" | cut -f9 | sort | uniq -c | sort -nr \
  | awk '{
      if ($2 ~ /402/) {
        block = $1
      };
      if ($2 ~ /302/) {
        slip = $1
      };
      sum+=$1
    } END {
      block_rate = block / sum * 100;
      slip_rate = slip / sum * 100;
      print "TOTAL\t" sum
      print "BLOCK\t" block "\t(" block_rate "%)"
      print "SLIP\t" slip "\t(" slip_rate "%)"
    }' \
  | tee ${APP_DIR}/public/spam-block-rate.txt

# Access Ranking Today
echo "${ACCESS_LOGS}" \
  | grep "time:$(date "+%Y-%m-%d")" \
  | grep 'status:200' \
  | grep -vP '\/(about|morygonzalez|author)' \
  | cut -f5 | sed -e 's/request_uri://' \
  | grep -vP ${REQUEST_PATH_TO_IGNORE} \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee ${APP_DIR}/public/access-ranking-today.txt

# Referer Ranking Today
echo "${ACCESS_LOGS}" \
  | grep "time:$(date "+%Y-%m-%d")" \
  | grep -vP "request_uri:.+?${REQUEST_PATH_TO_IGNORE}" \
  | cut -f12 | sed -e 's/referer://' \
  | grep -vP '(^-$|portalshit\.net)' \
  | sed -e 's/\?amp=1//' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee ${APP_DIR}/public/referer-ranking-today.txt

# Cache Hit Rate Today
echo "${CACHE_HIT_LOGS}" \
  | grep "time:$(date "+%Y-%m-%d")" \
  | grep 'cache_hit:' | grep -v 'cache_hit:-' \
  | cut -f16 | sort | uniq -c \
  | awk '{
      if ($2 ~ /HIT/) {
        hit = $1
      };
      if ($2 ~ /EXPIRED/) {
        expire = $1
      };
      if ($2 ~ /MISS/) {
        miss = $1
      };
      sum+=$1
    } END {
      hit_rate = hit / sum * 100;
      expired_rate = expire / sum * 100;
      miss_rate = miss / sum * 100;
      print "HIT\t" hit "\t(" hit_rate "%)"
      print "EXPIRE\t" expire "\t(" expired_rate "%)"
      print "MISS\t" miss "\t(" miss_rate "%)"
    }' \
  | tee ${APP_DIR}/public/cache-hit-rate-today.txt

# Spam Block Rate Today
echo "${ACCESS_LOGS}" \
  | grep "time:$(date "+%Y-%m-%d")" \
  | grep "POST" | grep -v "uri:/admin/" \
  | grep "referer:https://portalshit.net" | cut -f9 | sort | uniq -c | sort -nr \
  | awk '{
      if ($2 ~ /402/) {
        block = $1
      };
      if ($2 ~ /302/) {
        slip = $1
      };
      sum+=$1
    } END {
      block_rate = block / sum * 100;
      slip_rate = slip / sum * 100;
      print "TOTAL\t" sum
      print "BLOCK\t" block "\t(" block_rate "%)"
      print "SLIP\t" slip "\t(" slip_rate "%)"
    }' \
  | tee ${APP_DIR}/public/spam-block-rate-today.txt
