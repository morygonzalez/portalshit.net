#!/bin/bash

UA_TO_IGNORE='useragent:.+?(bot|feed|wget|fetcher|crawler|proxy|bubing|fastladder|ruby|aol\sreader|proximic|hatena|mediapartners-google|subscribe|slurp|phantomjs)'
REQUEST_PATH_TO_IGNORE='(\/yamap-widget-demo-page|\/imageproxy|\/api|favicon\.ico|index\.atom|\.js|\.json|\.css|\.jpe?g|\.png|\.gif|\.txt|\.php|\/admin|\/archives|^\-$|^\/$|^\/ogp|^\/amazon.+\.html)'

# Access Ranking
find /home/morygonzalez/sites/portalshit/log/access.log* \
  | xargs zcat -f \
  | grep 'status:200' \
  | grep -vE '\/(about|morygonzalez|author)' \
  | grep -viE ${UA_TO_IGNORE} \
  | cut -f5 | sed -e 's/request_uri://' \
  | grep -vE ${REQUEST_PATH_TO_IGNORE} \
  | sed -e 's/gain-profit-at-somebody-elses-profit/gain-profit-at-somebody-elses-expense/' \
  | sed -e 's/thought-on-own-house/thoughts-on-own-house/' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee /home/morygonzalez/sites/portalshit/public/access-ranking.txt

# Referer Ranking
find /home/morygonzalez/sites/portalshit/log/access.log* \
  | xargs zcat -f \
  | grep -viE ${UA_TO_IGNORE} \
  | grep -vE "request_uri:.+?${REQUEST_PATH_TO_IGNORE}" \
  | cut -f12 | sed -e 's/referer://' \
  | grep -vE '(^-$|portalshit\.net)' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee /home/morygonzalez/sites/portalshit/public/referer-ranking.txt

# Cache Hit Rate
find /home/morygonzalez/sites/portalshit/log/access.log* \
  | xargs zcat -f \
  | grep 'cache_hit:' | grep -v 'cache_hit:-' \
  | cut -f16 | sort | uniq -c \
  | awk '{if($2~/HIT/){hit=$1};if($2~/EXPIRED/){expire=$1};if($2~/MISS/){miss=$1};sum+=$1}END{hit_rate=hit/sum*100;expired_rate=expire/sum*100;miss_rate=miss/sum*100;print"HIT\t"hit_rate"%\n""EXPIRE\t"expired_rate"%\n""MISS\t"miss_rate"%"}' \
  | tee /home/morygonzalez/sites/portalshit/public/cache-hit-rate.txt

# Access Ranking Today
find /home/morygonzalez/sites/portalshit/log/access.log \
  | xargs zcat -f \
  | grep "time:$(date "+%Y-%m-%d")" \
  | grep 'status:200' \
  | grep -vE '\/(about|morygonzalez|author)' \
  | grep -viE ${UA_TO_IGNORE} \
  | cut -f5 | sed -e 's/request_uri://' \
  | grep -vE ${REQUEST_PATH_TO_IGNORE} \
  | sed -e 's/gain-profit-at-somebody-elses-profit/gain-profit-at-somebody-elses-expense/' \
  | sed -e 's/thought-on-own-house/thoughts-on-own-house/' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee /home/morygonzalez/sites/portalshit/public/access-ranking-today.txt

# Referer Ranking Today
find /home/morygonzalez/sites/portalshit/log/access.log \
  | xargs zcat -f \
  | grep "time:$(date "+%Y-%m-%d")" \
  | grep -viE ${UA_TO_IGNORE} \
  | grep -vE "request_uri:.+?${REQUEST_PATH_TO_IGNORE}" \
  | cut -f12 | sed -e 's/referer://' \
  | grep -vE '(^-$|portalshit\.net)' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee /home/morygonzalez/sites/portalshit/public/referer-ranking-today.txt

# Cache Hit Rate Today
find /home/morygonzalez/sites/portalshit/log/access.log \
  | xargs zcat -f \
  | grep 'cache_hit:' | grep -v 'cache_hit:-' \
  | cut -f16 | sort | uniq -c \
  | awk '{if($2~/HIT/){hit=$1};if($2~/EXPIRED/){expire=$1};if($2~/MISS/){miss=$1};sum+=$1}END{hit_rate=hit/sum*100;expired_rate=expire/sum*100;miss_rate=miss/sum*100;print"HIT\t"hit_rate"%\n""EXPIRE\t"expired_rate"%\n""MISS\t"miss_rate"%"}' \
  | tee /home/morygonzalez/sites/portalshit/public/cache-hit-rate-today.txt
