#!/bin/bash

zcat -f /home/morygonzalez/sites/portalshit/log/access.log* \
  | grep "status:200" \
  | grep -vE 'useragent:.+?(bot|Bot|Feed|Fetcher|Crawler|Fastladder|Ruby|Aol\sReader|proximic|Hatena\sAntenna|Mediapartners-Google|subscribe)' \
  | cut -f5 | sed -e 's/request_uri://' \
  | grep -vE '(favicon\.ico|index\.atom|\.js|\.json|\.css|\.jpe?g|\.png|\.gif|\.txt|\.php|\/admin|^\-$|^\/$)' \
  | sed -e 's/gain-profit-at-somebody-elses-profit/gain-profit-at-somebody-elses-expense/' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee /home/morygonzalez/sites/portalshit/public/access-ranking.txt
