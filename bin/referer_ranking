#!/bin/bash

zcat -f /home/morygonzalez/sites/portalshit/log/access.log* \
  | grep -vE 'useragent:.+?(bot|Bot|Feed|Fetcher|Crawler|Fastladder|Ruby|Aol\sReader|proximic|Hatena\sAntenna|Mediapartners-Google|subscribe)' \
  | grep -vE 'request_uri:.+?(favicon\.ico|index\.atom|\.js|\.json|\.css|\.jpe?g|\.png|\.gif|\.txt|\.php|\/admin|^\-$|^\/$)' \
  | cut -f12 | sed -e 's/referer://' \
  | grep -vE '(^-$|portalshit\.net)' \
  | sort | uniq -c | sort -nr | head -100 | sed -r 's/^[ \t]+//g' \
  | tee /home/morygonzalez/sites/portalshit/public/referer-ranking.txt
